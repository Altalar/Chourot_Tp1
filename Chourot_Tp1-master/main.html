<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Gestionnaire de contact</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <script src="js/jquery-3.3.1.js"></script>
    <!-- pour la dialogue de confirmation de retrait d'un contact -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-confirm/3.3.2/jquery-confirm.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-confirm/3.3.2/jquery-confirm.min.js"></script>
    <script src="js/jquery.maskedinput.js"></script>
    <link rel ="stylesheet" href="css/csscontact.css">
    <link rel="stylesheet" href="css/tooltip.css">
</head>
    <!--  le style contient tout en raison d'une regle sur le css de google chrome' -->
 <style id="dynamicStyle"></style>

<body>
</body>
<script>

    let dynamicstylesheet =document.styleSheets['dynamicStyle'];
    let editMode = false;
    let addMode = false;
    let selectedContact;

    let validationProvider;
    //création de la structure principale
    let bodyAccess = document.getElementsByTagName("BODY")[0];//le conteneur body, ou le body lui-meme
    let containerDiv = document.createElement('div');
    containerDiv.classList.add('container');
    bodyAccess.appendChild((containerDiv));
    let headcontent = document.createElement('h3');
    headcontent.innerHTML = "Gestionnaire de contacts";
    containerDiv.appendChild(headcontent);
    let containerArray = document.createElement('div');
    containerDiv.appendChild(containerArray);
    containerArray.classList.add('array-container');
    let headerContainer = document.createElement('div');
    headerContainer.classList.add('header-container');
    containerArray.appendChild(headerContainer);
    let divBar = document.createElement('div');
    divBar.classList.add('header-contacts-container');
    headerContainer.appendChild(divBar);
    let formContainer = document.createElement('div');
    formContainer.classList.add('form-container');
    formContainer.hidden =true;
    containerArray.appendChild(formContainer);
    let formContactContainer = document.createElement('form');
    formContactContainer.classList.add('form-contact-container');
    formContactContainer.id = 'contact-submit';
    formContainer.appendChild(formContactContainer);
    let scrollable = document.createElement('div');
    scrollable.classList.add('contact-list-scroll-container');
    containerArray.appendChild(scrollable);
    let divContact = document.createElement('div');
    divContact.classList.add('contact-list-container');
    scrollable.appendChild(divContact);

    //-------------------------------------------------------------------------
    //class validation par Nicolas Chourot
    class ValidationProvider{
        constructor(formId) {
            // initialiser la liste de ValidationControl
            this.validationControls = [];
            // conserver la référence sur le formulaire
            this.form = document.getElementById(formId);
            // Ajouter un call back de l'événement submit au formulaire
            this.form.addEventListener("submit", (e) => { this.submit(e);});
        }

        isValid() {
            let formValid = true;
            this.validationControls.forEach( validationControl => {
                if (!validationControl.isValid()) {
                    formValid = false;
                }
            });
            return formValid;
        }

        // Call back de l'événement submit
        submit(e) {

            if (!this.isValid()) {
                // empêcher la soumission
                e.preventDefault();
            }
            else {
                
                let phone = document.getElementById('phone');
                let email = document.getElementById('email');
                let firstname = document.getElementById('firstName');
                if (editMode)
                {
                    selectedContact.name = firstname.value;
                    selectedContact.phone = phone.value;
                    selectedContact.email = email.value;
                    selectedContact = null;
                    updatecontactlist(divContact, Contacts)
                    editMode = false;
                    clearTextbox();
                }
                else {
                    Contacts.push(new Contact(firstname.value, phone.value, email.value));
                    updatecontactlist(divContact, Contacts)
                    clearTextbox();
                }
                e.preventDefault();
            }
        }

        // Call back de l'événement change pour un des ValidationControls ciblé
        changed(e){
            this.validationControls.forEach((validationControl) => {
                if (validationControl.domElement.id === e.target.id) {
                    validationControl.isValid();
                }
            });
        }

        // ajout d'un ValidationControl
        // todo: ajouter la référence sur un tâche de validation à la soumission
        addControl(elementId, validationTask){
            let validationControl = new ValidationControl(elementId, validationTask);
            if (validationControl.domElement != null && (validationTask != undefined || validationTask != null)) {
                this.validationControls.push(validationControl);
                if (validationControl.domElement.tagName === "INPUT" ||
                    validationControl.domElement.tagName === "TEXTAREA") {
                    validationControl.domElement.addEventListener("input", (e) => { this.changed(e); });
                    validationControl.domElement.addEventListener("blur", (e) => { this.changed(e); });
                }
                else
                    validationControl.domElement.addEventListener("change", (e) => { this.changed(e); });
            }
        }
    }
class ValidationControl {
    constructor(elementId, validationTask) {
        // conserver l'élément à valider
        this.domElement = document.getElementById(elementId);
        if (this.domElement != null) {
            if (validationTask != undefined || validationTask != null) {
                // conserver sa méthode de validation qui
                // retourne une chaine vide si valide sinon un message d'erreur
                this.validationTask = validationTask;
                // insérér un message d'erreur masqué
                if (this.domElement != null) {
                    this.errorIndicator = document.createElement("div");
                    this.errorIndicator.style.display = "none";
                    this.errorIndicator.style.color = "red";
                    this.errorIndicator.textContent = "test";
                    this.domElement.insertAdjacentElement("afterend", this.errorIndicator);
                    eraseForm();
                }
            }
            else {
                console.log("ValidationControl: validationTask inexistant");
            }
        }
        else{
            console.log("ValidationControl: controlId inexistant");
        }
    }

    // démasquer le message d'erreur
    showError(message) {
        this.errorIndicator.style.display = "block";
        this.errorIndicator.textContent = message;
    }

    // masquer le message d'erreur
    hideError() {
        this.errorIndicator.style.display = "none";
    }

    // Mettre à jour la visibilité du message d'erreur
    // retourne vrai si valide
    isValid() {
        // vérifier la validité
        let errorMessage = this.validationTask();
        // mettre à jour la visibilité du message d'erreur
        if (errorMessage !== "") {
            this.showError(errorMessage);
        }
        else {
            this.hideError();
        }
        // un message d'erreur vide indique qu'il n'y a pas d'erreur
        return errorMessage === "";
    }
}
    //par le meme auteur
    function makeTextBox(name, placeHolder, cssClass){
        let textBox = document.createElement('input');
        textBox.type ="text";
        textBox.name = name;
        textBox.id = name;
        textBox.placeholder = placeHolder;
        textBox.classList.add(cssClass);
        return textBox;
    }
    function addClass(element, cssClass) {
        let css = cssClass.split(" ");
        css.forEach(item => {element.classList.add(item)});
    }
    //----------------------------------------------------------------------------
    class Contact {
		
        constructor(name, phone, email){this.name = name; this.phone = phone; this.email = email;}
    }
    let Contacts = [];

    function BuildListContact () {
        Contacts.push(new Contact("Simon", "514-333-4541", "monmail@gmail.ca"));
        Contacts.push(new Contact("test", "123-456-7890", "test@hotmail.com"));
        Contacts.push(new Contact("Bruneauo", "450-123-4567", "isthisdogorgod@gmail.god"));
        Contacts.push(new Contact("nath", "450-478-7777", "monmail@gmail.dog"));
    }

    function Buildable(content, css,color)//renommé par webstorm parce qu'il chialait
    {
        let cell = document.createElement('div');
        cell.innerHTML = content;
            cell.classList.add(css);
            cell.classList.add(color);
            cell.classList.add('cell');
            cell.onmouseover = function() {(cellOver(cell))};
            cell.onmouseleave = function() {(cellLeave(cell))};
        return cell;
    }
    function BuildBtnRowContainer(css,color)//renommé par webstorm parce qu'il chialait
    {
        let cell = document.createElement('div');
        cell.classList.add(css);
        cell.classList.add(color);
        cell.classList.add('rowBtnContainer');
        cell.onmouseover = function() {(cellOver(cell))};
        cell.onmouseleave = function() {(cellLeave(cell))};
        return cell;
    }
    function makeBTN(css, id, toolTip, position,myimage) {
        let btn = document.createElement('button');
        btn.setAttribute('toolTip', toolTip);
        btn.setAttribute('toolTip-Position', position);
        btn.classList.add(css);
        btn.id = id;
        let span = document.createElement('span');
        btn.appendChild(span);
        span.classList.add(myimage);
        return btn;
    }

    function createContactRow(contact, row_index, container,color) {
        let rowClass = "row_" + row_index;
        container.appendChild(Buildable(contact.name, rowClass,color));
        container.appendChild(Buildable(contact.phone, rowClass,color));
        container.appendChild(Buildable(contact.email, rowClass,color));
        let btncontainer1 = Buildable("",rowClass,color);
        let btncontainer2 = Buildable("",rowClass,color);
        let btnEdit = makeBTN('edit_' + row_index, "glyphicon-pencil", "modifier " + contact.name,'left',"edit");
        let btnDel =makeBTN('Delete_' + row_index,"glyphicon-pencil", "supprimer " + contact.name,'left',"delete");
        let containercontainer = BuildBtnRowContainer(rowClass,color);
        let containercontainer2 = BuildBtnRowContainer(rowClass,color);
        container.appendChild(containercontainer);
        containercontainer.appendChild(btncontainer1);
        btncontainer1.hidden = true;
        container.appendChild(containercontainer2)
        containercontainer2.appendChild(btncontainer2);
        btncontainer2.hidden = true;
        btncontainer1.appendChild(btnEdit);
        btncontainer2.appendChild(btnDel);
        btnDel.addEventListener("click", () =>{confirmDel("supprimer "+ contact.name, contact)});
        btnEdit.addEventListener("click",() =>{editContact(contact)});
    }
    function updatecontactlist(container, Contacts) {
        while (container.firstChild != null) {
            container.removeChild(container.firstChild);
            }
        let oddRow = true;
        let rowindex = 0;
        for (let Content of Contacts) {
            createContactRow(Content, rowindex++, container,(oddRow?  "oddRow": "evenRow"));
            oddRow = !oddRow;
        }
    }
    function buildContactList(container, contacts)
    {
        let oddRow = true;
        let rowindex = 0;
        for (let Content of contacts) {
            createContactRow(Content, rowindex++, container,(oddRow?  "oddRow": "evenRow"));
            oddRow = !oddRow;
        }
    }
    function buildAddContactBar(container)
    {
        let rowClass = "AddContactBar";
        container.appendChild(Buildable("Nom", rowClass));
        container.appendChild(Buildable("Telephone", rowClass));
        container.appendChild(Buildable("Email", rowClass));
        let btnContain = Buildable("",rowClass,'AddBtnContainer');
        let btnShow =makeBTN('Add_Contact', rowClass + "glyphicon-ok", "Ajouter un contact",'left',"add");
        let containerOfContainer = buildContainer(rowClass);
        btnContain.appendChild(btnShow);
        btnShow.addEventListener("click", (event) =>{showEditContact(); addMode = true});
        container.appendChild(containerOfContainer);
        containerOfContainer.appendChild(btnContain);
        container.appendChild(Buildable("", rowClass));
    }
    function buildEditContact(container)
    {
        let rowClass = "form-contact_row";
        let namecontainer = buildContainer(rowClass);
        container.appendChild(namecontainer);
        namecontainer.appendChild(makeTextBox("firstName","Prénom", rowClass));
        let phonecontainer = buildContainer(rowClass);
        container.appendChild(phonecontainer);
        phonecontainer.appendChild(makeTextBox("phone","Telephone", rowClass));
        let emailcontainer = buildContainer(rowClass);
        container.appendChild(emailcontainer);
        emailcontainer.appendChild(makeTextBox("email","Courriel", rowClass));
        let btnAddContainer = buildContainer(rowClass);
		let btnCnlContainer = buildContainer(rowClass);
        let btnSubmit = makeBTN('Add_Contact', rowClass + " glyphicon-ok","Ajouter le contact",'left',"submit");
		let btnCnl = makeBTN('Cancel', rowClass + " glyphicon-repeat","annuler",'left',"cancel");
        container.appendChild(btnAddContainer);
		container.appendChild(btnCnlContainer);
		btnAddContainer.appendChild(btnSubmit);
        btnCnlContainer.appendChild(btnCnl);
		btnCnlContainer.addEventListener("click",() =>{clearTextbox()});
    }
    function buildContainer(css)
    {
        let cell = document.createElement('div');
        cell.classList.add(css);
        return cell;
    }
    function hideEditContact()
    {
        formContainer.hidden =true;
        let btn = document.getElementsByClassName('AddBtnContainer');
        for (let item of btn) {
            item.hidden = false;
        }
    }
    function showEditContact()
    {
        formContainer.hidden =false;
        let btn = document.getElementsByClassName('AddBtnContainer');
        for (let item of btn) {
            item.hidden = true;
        }
    }
    function cellOver(e){
        if(!editMode) {
            let classname = e.classList.item(0);
            let row = document.getElementsByClassName(classname);
            for (let item of row) {
                item.classList.add("selectedRow");
                if (!item.classList.contains('AddBtnContainer')) {
                    item.hidden = false;
                }
            }
        }
    }
    function cellLeave(e){
        if(!editMode) {
            let classname = e.classList.item(0);
            let row = document.getElementsByClassName(classname);
            for (let item of row) {
                item.classList.remove("selectedRow");
                if (item.classList.contains('rowBtnContainer')) {
                    item.firstElementChild.hidden =true;
                }
            }
        }
    }
    function eraseForm() {
        addMode = false;
        editMode = false;
    }

    function initValidation() {
        $(".phone").mask("(999) 999-9999");
        validationProvider = new ValidationProvider('contact-submit');
        validationProvider.addControl("firstName", validate_Name);
        validationProvider.addControl("phone", validate_Phone);
        validationProvider.addControl("email", validate_email);
    }

    function validate_Name(){
        let TBX_FirstName = document.getElementById("firstName");

        if (TBX_FirstName.value === "")
            return "Nom manquant";

        return "";
    }

    function validate_Phone(){
        let TBX_LastName = document.getElementById("phone");

        if (TBX_LastName.value === "")
            return "Téléphone manquant";

        return "";
    }

    function validate_email(){
        let TBX_Email = document.getElementById("email");
        let emailRegex = /^([\w\.\-]+)@([\w\-]+)((\.(\w){2,3})+)$/;

        if (TBX_Email.value === "")
            return "Adresse de courriel manquante";

        if (!emailRegex.test(TBX_Email.value))
            return "Adresse de courriel invalide";

        return "";
    }
    function confirmDel(message,contact) {
        $.confirm({
            title: 'Attention!',
            content: message,
            buttons: {
                confirmer: function () {
                    supprimerContact(contact); 
                },
                annuler: function () {
                }
            }
        });
    }
    function editContact(contact)
    {
        editMode = true;
        showEditContact();
        selectedContact = contact;
        let phone = document.getElementById('phone');
        let email = document.getElementById('email');
        let firstname = document.getElementById('firstName');
        phone.value = contact.phone;
		email.value =contact.email;
        firstname.value = contact.name;

    }
    function supprimerContact(contact)
    {
        Contacts.splice(Contacts.indexOf(contact),1);
        updatecontactlist(divContact,Contacts);
    }
	function
    clearTextbox()
    {
        let phone = document.getElementById('phone');
        let email = document.getElementById('email');
        let firstname = document.getElementById('firstName');
        phone.value = "";
        email.value = "";
        firstname.value = "";
		addMode = false;
        editMode = false;
        hideEditContact();
    }

    console.log(Contacts)
    BuildListContact();
    buildAddContactBar(divBar);
    buildEditContact(formContactContainer);
	buildContactList(divContact,Contacts);
    initValidation();
	

    //$('.editContact').click(showEditContact);
</script>
</html>